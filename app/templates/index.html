<!DOCTYPE html>
<html>
<head>
  <title>LunchOrder API Client Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='knockout-min.js') }}"></script>
  <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
</head>
<body>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <a class="navbar-brand" href="#">LunchOrder Client Demo</a>
        </div>
    </nav>
    <div id="main" class="container">
        <table class="table table-striped">
            <tr><th>Restaurant</th><th>Rating</th><th>Options</th></tr>
            <!-- ko foreach: lst -->
            <tr>
                <td>
                    <p><b data-bind="text: title"></b></p>
                    <p data-bind="text: telephone"></p>
                </td>
                <td>
                    <p data-bind="text: rating"></p>
                </td>
                <td>
                    <div class="btn-group">
                        <button data-bind="click: $parent.beginEdit" class="btn btn-default">Edit</button>
                        <button data-bind="click: $parent.remove" class="btn btn-default">Delete</button>
                        <button data-bind="click: $parent.rankUp" class="btn btn-default">rank up</button>
                        <button data-bind="click: $parent.rankDown" class="btn btn-default">rank down</button>
                    </div>
                </td>
            </tr>
            <!-- /ko -->
        </table>
        <button data-bind="click: beginAdd" class="btn">Add Restaurant</button>
    </div>
    <div id="log" class="container"></div>
    <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){

        var socket = io.connect('http://' + document.domain + ':' + location.port + '/test');

        function RestaurantsViewModel() {
            var self = this;
            self.base_uri = '/api/restaurants';
            self.lst = ko.observableArray();

            self.ajax = function(uri, method, data) {
                var request = {
                    url: uri,
                    type: method,
                    contentType: "application/json",
                    accepts: "application/json",
                    cache: false,
                    dataType: 'json',
                    data: JSON.stringify(data),
                    error: function(jqXHR) {
                        console.log("ajax error " + jqXHR.status);
                    }
                };
                return $.ajax(request);
            }

            self.beginAdd = function() {
                alert("Add");
            }
            self.beginEdit = function(restaurant) {
                alert("Edit: " + restaurant.title());
            }
            self.remove = function(restaurant) {
                self.ajax(restaurant.uri(), 'DELETE').done(function() {
                    self.lst.remove(restaurant);
                });
            }
            self.rankUp = function(restaurant) {
                self.ajax(restaurant.uri(), 'PUT', { "op": "rankup" }).done(function(res){
                    var i = self.lst.indexOf(restaurant);
                    socket.emit('update', {'uri': restaurant.uri()});
                });
            }
            self.rankDown = function(restaurant) {
                self.ajax(restaurant.uri(), 'PUT', { "op": "rankdown" }).done(function(res){
                    var i = self.lst.indexOf(restaurant);
                    socket.emit('update', {'uri': restaurant.uri()});
                });
            }

            self.update = function(index, restaurant) {
//                self.restaurants()[index].uri(restaurant.uri);
                self.lst()[index].title(restaurant.title);
                self.lst()[index].telephone(restaurant.telephone);
                self.lst()[index].rating(restaurant.rating);
            }

            self.ajax(self.base_uri, 'GET').done(function(data) {
                data.restaurants.forEach(function(r){
                    self.lst.push({
                        uri: ko.observable(r.uri),
                        title: ko.observable(r.title),
                        telephone: ko.observable(r.telephone),
                        rating: ko.observable(r.rating)
                    });
                });
            });
        }

        restaurants = new RestaurantsViewModel();
        ko.applyBindings(restaurants, $('#main')[0]);

        socket.on('my response', function(msg) {
            $('#log').append('<br>Received on: ' + msg.data);
        });

        socket.on('refresh', function(msg) {
            restaurants.ajax(msg.uri, 'GET').done(function(data) {
                for (i = 0; i < restaurants.lst().length; i++) {
                    if (restaurants.lst()[i].uri() == data.restaurant.uri) {
                        restaurants.update(i, data.restaurant);
                        break;
                    }
                };
            });
        });

        $('#log').append('<br>' + document.domain + ':' + location.port);
    });
    </script>
</body>
