<!DOCTYPE html>
<html>
<head>
  <title>LunchOrder API Client Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='knockout-min.js') }}"></script>
</head>
<body>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <a class="navbar-brand" href="#">LunchOrder Client Demo</a>
        </div>
    </nav>
    <div id="main" class="container">
        <table class="table table-striped">
            <tr><td>Restaurant</td><td>Rating</td><td>Options</td></tr>
            <!-- ko foreach: restaurants -->
            <tr>
                <td>
                    <p><b data-bind="text: title"></b></p>
                    <p data-bind="text: telephone"></p>
                </td>
                <td>
                    <p data-bind="text: rating"></p>
                </td>
                <td>
                    <div class="btn-group">
                    <button data-bind="click: $parent.beginEdit" class="btn btn-default">Edit</button>
                    <button data-bind="click: $parent.remove" class="btn btn-default">Delete</button>
                      <button data-bind="click: $parent.rankUp" class="btn btn-default">rank up</button>
                      <button data-bind="click: $parent.rankDown" class="btn btn-default">rank down</button>
                    </div>
                </td>
            </tr>
            <!-- /ko -->
        </table>
        <button data-bind="click: beginAdd" class="btn">Add Restaurant</button>
    </div>
    <script type="text/javascript">
    function RestaurantsViewModel() {
        var self = this;
        self.restaurants_uri = '/api/restaurants';
        self.restaurants = ko.observableArray();

        self.ajax = function(uri, method, data) {
            var request = {
                url: uri,
                type: method,
                contentType: "application/json",
                accepts: "application/json",
                cache: false,
                dataType: 'json',
                data: JSON.stringify(data),
                error: function(jqXHR) {
                    console.log("ajax error " + jqXHR.status);
                }
            };
            return $.ajax(request);
        }

        self.beginAdd = function() {
            alert("Add");
        }
        self.beginEdit = function(restaurant) {
            alert("Edit: " + restaurants.title());
        }
        self.remove = function(restaurant) {
            self.ajax(restaurant.uri(), 'DELETE').done(function() {
              self.restaurants.remove(restaurant);
            });
        }
        self.rankUp = function(restaurant) {
            self.ajax(restaurant.uri(), 'PUT', { rating: restaurant.rating() + 1 }).done(function(res){
              self.updateRestaurant(restaurant, res.restaurant);
            });
        }
        self.rankDown = function(restaurant) {
            self.ajax(restaurant.uri(), 'PUT', { rating: restaurant.rating() - 1 }).done(function(res){
              self.updateRestaurant(restaurant, res.restaurant);
            });
        }

        self.updateRestaurant = function(restaurant_from, restaurant_to) {
          var i = self.restaurants.indexOf(restaurant_from);
          self.restaurants()[i].uri(restaurant_to.uri);
          self.restaurants()[i].title(restaurant_to.title);
          self.restaurants()[i].telephone(restaurant_to.telephone);
          self.restaurants()[i].rating(restaurant_to.rating);
        }

        self.ajax(self.restaurants_uri, 'GET').done(function(data) {
            for (var i = 0; i < data.restaurants.length; i++) {
                self.restaurants.push({
                    uri: ko.observable(data.restaurants[i].uri),
                    title: ko.observable(data.restaurants[i].title),
                    telephone: ko.observable(data.restaurants[i].telephone),
                    rating: ko.observable(data.restaurants[i].rating)
                });
            }
        });
    }
    ko.applyBindings(new RestaurantsViewModel(), $('#main')[0]);
    </script>
</body>
