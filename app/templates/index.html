<!DOCTYPE html>
<html>
<head>
  <title>LunchOrder API Client Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="{{ url_for('static', filename='bootstrap.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='jquery.min.js') }}"></script>
  <script src="{{ url_for('static', filename='bootstrap.min.js') }}"></script>
  <script src="{{ url_for('static', filename='knockout-min.js') }}"></script>
  <script src="{{ url_for('static', filename='socket.io.min.js') }}"></script>
</head>
<body>
    <nav class="navbar navbar-default" role="navigation">
        <div class="container">
            <a class="navbar-brand" href="#">LunchOrder Client Demo</a>
        </div>
    </nav>
    <div id="main" class="container">
        <table class="table table-striped">
            <tr><th>Restaurant</th><th>Rating</th><th>Options</th></tr>
            <!-- ko foreach: restaurants -->
            <tr>
                <td>
                    <p><b data-bind="text: title"></b></p>
                    <p data-bind="text: telephone"></p>
                </td>
                <td>
                    <p data-bind="text: rating"></p>
                </td>
                <td>
                    <div class="btn-group">
                        <button data-bind="click: $parent.beginEdit" class="btn btn-default">Edit</button>
                        <button data-bind="click: $parent.remove" class="btn btn-default">Delete</button>
                        <button data-bind="click: $parent.rankUp" class="btn btn-default">rank up</button>
                        <button data-bind="click: $parent.rankDown" class="btn btn-default">rank down</button>
                    </div>
                </td>
            </tr>
            <!-- /ko -->
        </table>
        <button data-bind="click: beginAdd" class="btn">Add Restaurant</button>
    </div>
    <div id="log" class="container"></div>
    <script type="text/javascript" charset="utf-8">
    $(document).ready(function(){

        var socket = io.connect('http://' + document.domain + ':' + location.port + '/test');

        function RestaurantsViewModel() {
            var self = this;
            self.restaurants_uri = '/api/restaurants';
            self.restaurants = ko.observableArray();

            self.ajax = function(uri, method, data) {
                var request = {
                    url: uri,
                    type: method,
                    contentType: "application/json",
                    accepts: "application/json",
                    cache: false,
                    dataType: 'json',
                    data: JSON.stringify(data),
                    error: function(jqXHR) {
                        console.log("ajax error " + jqXHR.status);
                    }
                };
                return $.ajax(request);
            }

            self.beginAdd = function() {
                alert("Add");
            }
            self.beginEdit = function(restaurant) {
                alert("Edit: " + restaurants.title());
            }
            self.remove = function(restaurant) {
                self.ajax(restaurant.uri(), 'DELETE').done(function() {
                    self.restaurants.remove(restaurant);
                });
            }
            self.rankUp = function(restaurant) {
                self.ajax(restaurant.uri(), 'PUT', { "op": "rankup" }).done(function(res){
                    var i = self.restaurants.indexOf(restaurant);
                    self.updateRestaurant(i, res.restaurant);
                    //socket.emit('rank event', {'data': 'rank up'});
                });
            }
            self.rankDown = function(restaurant) {
                self.ajax(restaurant.uri(), 'PUT', { "op": "rankdown" }).done(function(res){
                    var i = self.restaurants.indexOf(restaurant);
                    self.updateRestaurant(i, res.restaurant);
                    //socket.emit('rank event', {'data': 'rank down'});
                });
            }

            self.updateRestaurant = function(index, restaurant_resp) {
                self.restaurants()[index].uri(restaurant_resp.uri);
                self.restaurants()[index].title(restaurant_resp.title);
                self.restaurants()[index].telephone(restaurant_resp.telephone);
                self.restaurants()[index].rating(restaurant_resp.rating);
            }

            self.ajax(self.restaurants_uri, 'GET').done(function(data) {
                for (var i = 0; i < data.restaurants.length; i++) {
                    self.restaurants.push({
                        uri: ko.observable(data.restaurants[i].uri),
                        title: ko.observable(data.restaurants[i].title),
                        telephone: ko.observable(data.restaurants[i].telephone),
                        rating: ko.observable(data.restaurants[i].rating)
                    });
                }
            });
        }
        ko.applyBindings(new RestaurantsViewModel(), $('#main')[0]);

        socket.on('my response', function(msg) {
            $('#log').append('<br>Received on: ' + msg.data);
        });

        $('#log').append('<br>' + document.domain + ':' + location.port);
    });
    </script>
</body>
